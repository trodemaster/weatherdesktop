#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'
shopt -s nullglob nocaseglob

# kill all child proceses
kill_spawn() {
  for SPAWN in $(pgrep -g $$); do
    kill $SPAWN
  done
}

# kill_spawn on exit and ctrl-c
trap kill_spawn EXIT SIGINT

trap 'catch' ERR
catch() {
  echo "An error has occurred but we're going to eat it!!"
}

# Define global variables and set defaults
CHROME="/Applications/Google Chrome.app/Contents/MacOS/Google Chrome"
SCRAPE=1
DOWNLOAD=1
CROP=1
RENDER=1

# print out usage
usage() {
  cat <<EOF
USAGE: ./wd -s 
OPTIONS:
   -s    Scrape Sites
   -d    Download Images
   -c    Crop Images
   -r    Render Image
   -h    Help
EOF
  exit 0
}

# process options and arguments
while getopts "hsdcr" OPTION; do
  case $OPTION in
  h) usage ;;
  s) SCRAPE=0 ;;
  d) DOWNLOAD=0 ;;
  c) CROP=0 ;;
  r) RENDER=0 ;;
  esac
done

scrape() {
  set +e
  OUTPUT_FILE="$1"
  WINDOW_SIZE="$2"
  TARGET_URL="$3"

  # create temp dir if it doesn't exist
  if ! [[ -d ${TMPDIR}wd ]]; then
    mkdir ${TMPDIR}wd
  fi

  # retry with counter
  RETRY_COUNTER=0
  until [ "$RETRY_COUNTER" -ge 5 ]; do
    echo "scraping $OUTPUT_FILE"
    timeout 15s "$CHROME" --headless --run-all-compositor-stages-before-draw --virtual-time-budget=10000 -disk-cache-dir=${TMPDIR}wd --user-data-dir=${TMPDIR}wd --crash-dumps-dir=${TMPDIR}wd --screenshot="$OUTPUT_FILE" --window-size="$WINDOW_SIZE" "$TARGET_URL" && break
    RETRY_COUNTER=$((RETRY_COUNTER + 1))
  done
}

# do the scrape
if [[ $SCRAPE == 0 ]]; then
  scrape "assets/weather_gov_extended.jpg" "1400,1200" "https://forecast.weather.gov/MapClick.php?lat=47.7456&lon=-121.0892" &
  scrape "assets/nwac_stevens_weather.jpg" "900,1600" "https://nwac.us/data-portal/graph/21/" &
  scrape "assets/noaa_obs_stevens.jpg" "900,1800" "https://www.wrh.noaa.gov/mesowest/getobext.php?wfo=sew&sid=SVNW1" &
  scrape "assets/nwac_avalanch.jpg" "900,2800" "https://nwac.us/avalanche-forecast/#/stevens-pass" &
  scrape "assets/nwac_overview.jpg" "800,1200" "https://nwac.us/" &
  scrape "assets/weather_gov_extended.jpg" "1400,1200" "https://forecast.weather.gov/MapClick.php?lat=47.7456&lon=-121.0892" &
  scrape "assets/weather_gov_hourly.jpg" "1000,1800" "https://forecast.weather.gov/MapClick.php?lat=47.7456&lon=-121.0892&unit=0&lg=english&FcstType=graphical" &
fi

download() {
  set +e
  OUTPUT_FILE="$1"
  TARGET_URL="$2"
  # retry with counter
  RETRY_COUNTER=0
  until [ "$RETRY_COUNTER" -ge 5 ]; do
    echo "Downloading $OUTPUT_FILE"
    wget --quiet "$TARGET_URL" -O "$OUTPUT_FILE" && break
    sleep 5
    RETRY_COUNTER=$((RETRY_COUNTER + 1))
  done
}

# do the download
if [[ $DOWNLOAD == 0 ]]; then
  download "assets/wsdot_stevens_pass.jpg" "https://images.wsdot.wa.gov/nc/002vc06430.jpg" &
  download "assets/wsdot_us2_skykomish.jpg" "https://images.wsdot.wa.gov/nw/002vc04558.jpg" &
  download "assets/wsdot_mill_creek.jpg" "https://images.wsdot.wa.gov/nc/002vc07057.jpg" &
  download "assets/wsdot_e_stevens_summit.jpg" "https://images.wsdot.wa.gov/nc/002vc06458.jpg" &
  download "assets/wsdot_big_windy.jpg" "https://images.wsdot.wa.gov/nc/002vc06300.jpg" &
  download "assets/wsdot_w_stevens.jpg" "https://images.wsdot.wa.gov/nc/002vc06190.jpg" &
  download "assets/GOES17_north_pacific.jpg" "https://cdn.star.nesdis.noaa.gov/GOES17/ABI/SECTOR/np/GEOCOLOR/latest.jpg" &
  download "assets/stevens_cowboy_mountain.jpg" "http://common.snow.com/mtncams/Cowboy%20Mountain.jpg" &
  download "assets/stevens_skyline.jpg" "http://common.snow.com/mtncams/Skyline.jpg" &
  download "assets/stevens_glacier_peak.jpg" "http://common.snow.com/mtncams/Glacier%20Peak.jpg" &
  download "assets/stevens_gemini.jpg" "http://common.snow.com/mtncams/Gemini.jpg" &
  download "assets/stevens_south_divide.jpg" "http://common.snow.com/mtncams/South%20Divide.jpg" &
  download "assets/stevens_spbasearea.jpg" "http://common.snow.com/mtncams/SPBaseArea.jpg" &
fi

# wait for asset collection to complete
wait
echo "Asset Collection Completed..."

# crop and resize
if [[ $CROP == 0 ]]; then
  convert assets/GOES17_north_pacific.jpg -crop 7200x4050+0+0 -resize "3840>" assets/background_s.jpg &
  convert assets/nwac_stevens_weather.jpg -crop 1450x2250+100+400 -resize "750>" assets/nwac_stevens_weather_s.jpg &
  convert assets/nwac_avalanch.jpg -crop 1325x2700+200+1800 -resize "30%" assets/nwac_avalanch_s.jpg &
  convert assets/weather_gov_hourly.jpg -crop 1690x1800+150+800 -resize "50%" assets/weather_gov_hourly_s.jpg &
  convert assets/weather_gov_extended.jpg -crop 2300x550+250+1400 -resize "50%" assets/weather_gov_extended_s.jpg &
  convert assets/stevens_cowboy_mountain.jpg -crop 1920x1080+0+0 -resize "50%" assets/stevens_cowboy_mountain_s.jpg &
  convert assets/stevens_skyline.jpg -crop 1920x1080+0+0 -resize "30%" assets/stevens_skyline_s.jpg &
  convert assets/stevens_glacier_peak.jpg -crop 1920x1080+0+0 -resize "30%" assets/stevens_glacier_peak_s.jpg &
  convert assets/stevens_gemini.jpg -crop 1920x1080+0+0 -resize "30%" assets/stevens_gemini_s.jpg &
  convert assets/stevens_south_divide.jpg -crop 1920x1080+0+0 -resize "50%" assets/stevens_south_divide_s.jpg &
  convert assets/stevens_spbasearea.jpg -crop 1920x1080+0+0 -resize "30%" assets/stevens_spbasearea_s.jpg &

  wait
  echo "Croping completed..."
fi

# composit the image
if [[ $RENDER == 0 ]]; then
  RENDERED_FILENAME=hud-$(date "+%y%m%d-%H%M").jpg
  convert -size 3840x2160 xc:skyblue \
    assets/background_s.jpg -geometry +0+0 -composite \
    assets/nwac_stevens_weather_s.jpg -geometry +50+50 -composite \
    assets/wsdot_us2_skykomish.jpg -geometry +825+50 -composite \
    assets/wsdot_w_stevens.jpg -geometry +1175+50 -composite \
    assets/wsdot_big_windy.jpg -geometry +1526+50 -composite \
    assets/wsdot_stevens_pass.jpg -geometry +1875+50 -composite \
    assets/wsdot_e_stevens_summit.jpg -geometry +2226+50 -composite \
    assets/wsdot_mill_creek.jpg -geometry +2586+50 -composite \
    assets/stevens_cowboy_mountain_s.jpg -geometry +910+900 -composite \
    assets/stevens_skyline_s.jpg -geometry +1504+1780 -composite \
    assets/stevens_glacier_peak_s.jpg -geometry +2115+1780 -composite \
    assets/stevens_gemini_s.jpg -geometry +2725+1780 -composite \
    assets/stevens_south_divide_s.jpg -geometry +840+330 -composite \
    assets/stevens_spbasearea_s.jpg -geometry +910+1780 -composite \
    assets/nwac_avalanch_s.jpg -geometry +3250+50 -composite \
    assets/weather_gov_hourly_s.jpg -geometry +50+1230 -composite \
    assets/weather_gov_extended_s.jpg -geometry +920+1476 -composite \
    rendered/$RENDERED_FILENAME
  echo "Rendering Completed..."
fi

echo "End of Line..."
exit 0
